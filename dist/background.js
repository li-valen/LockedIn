if("undefined"!=typeof window){const e=document.createElement;document.createElement=function(t){const s=e.call(this,t);if("script"===t.toLowerCase()){const e=s.setAttribute;s.setAttribute=function(t,s){if("src"!==t||!s.includes("apis.google.com")&&!s.includes("recaptcha"))return e.call(this,t,s);console.warn("External script loading blocked:",s)}}return s}}(()=>{"use strict";var e,t,s={},i={};function a(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={exports:{}};return s[e](r,r.exports,a),r.exports}a.m=s,a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce((t,s)=>(a.f[s](e,t),t),[])),a.u=e=>({76:"common",83:"firebase-d3094b5a",96:"vendors",368:"firebase-4514f456",424:"firebase-19f9d112",515:"firebase-0520917b",977:"firebase-ab1f98e4"}[e]+".js"),a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="lockedin-extension:",a.l=(s,i,r,o)=>{if(e[s])e[s].push(i);else{var c,n;if(void 0!==r)for(var d=document.getElementsByTagName("script"),l=0;l<d.length;l++){var h=d[l];if(h.getAttribute("src")==s||h.getAttribute("data-webpack")==t+r){c=h;break}}c||(n=!0,(c=document.createElement("script")).charset="utf-8",a.nc&&c.setAttribute("nonce",a.nc),c.setAttribute("data-webpack",t+r),c.src=s),e[s]=[i];var k=(t,i)=>{c.onerror=c.onload=null,clearTimeout(u);var a=e[s];if(delete e[s],c.parentNode&&c.parentNode.removeChild(c),a&&a.forEach(e=>e(i)),t)return t(i)},u=setTimeout(k.bind(null,void 0,{type:"timeout",target:c}),12e4);c.onerror=k.bind(null,c.onerror),c.onload=k.bind(null,c.onload),n&&document.head.appendChild(c)}},a.j=471,(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var i=s.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=s[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={471:0};a.f.j=(t,s)=>{var i=a.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var r=new Promise((s,a)=>i=e[t]=[s,a]);s.push(i[2]=r);var o=a.p+a.u(t),c=new Error;a.l(o,s=>{if(a.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var r=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;c.message="Loading chunk "+t+" failed.\n("+r+": "+o+")",c.name="ChunkLoadError",c.type=r,c.request=o,i[1](c)}},"chunk-"+t,t)}};var t=(t,s)=>{var i,r,[o,c,n]=s,d=0;if(o.some(t=>0!==e[t])){for(i in c)a.o(c,i)&&(a.m[i]=c[i]);n&&n(a)}for(t&&t(s);d<o.length;d++)r=o[d],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0},s=self.webpackChunklockedin_extension=self.webpackChunklockedin_extension||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),a.nc=void 0,console.log("LockedIn background service worker started"),new class{constructor(){this.data={workSites:["github.com","figma.com","notion.so","linear.app"],currentWorkTime:0,isWorking:!1,startTime:0,dailyWorkTime:0,lastResetDate:(new Date).toDateString()},this.isUserActive=!0,this.isSystemActive=!0,this.lastActivityTime=Date.now(),this.activityCheckInterval=null,this.initialize()}async initialize(){await this.loadData(),this.setupEventListeners(),this.startTracking(),this.resetDailyIfNeeded()}async loadData(){try{const e=await chrome.storage.local.get(["workTrackerData"]);e.workTrackerData&&(this.data={...this.data,...e.workTrackerData}),await this.saveData()}catch(e){console.error("Failed to load data:",e)}}async saveData(){try{await chrome.storage.local.set({workTrackerData:this.data})}catch(e){console.error("Failed to save data:",e)}}setupEventListeners(){chrome.tabs.onUpdated.addListener((e,t,s)=>{"complete"===t.status&&s.url&&this.checkWorkSite(s.url)}),chrome.tabs.onActivated.addListener(async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&this.checkWorkSite(t.url)}catch(e){console.error("Error getting tab:",e)}}),chrome.windows.onFocusChanged.addListener(async e=>{if(e===chrome.windows.WINDOW_ID_NONE)this.pauseTracking();else try{const[t]=await chrome.tabs.query({active:!0,windowId:e});t?.url&&this.checkWorkSite(t.url)}catch(e){console.error("Error checking active tab:",e)}}),chrome.idle.onStateChanged.addListener(e=>{console.log("Idle state changed:",e),"active"===e?(this.isUserActive=!0,this.isSystemActive=!0,this.lastActivityTime=Date.now(),this.checkCurrentTab()):"locked"===e?(this.isSystemActive=!1,this.pauseTracking()):"idle"===e&&(this.isUserActive=!1,console.log("User marked as idle but continuing to track"))}),chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,t,s),!0)),chrome.runtime.onInstalled.addListener(()=>{console.log("LockedIn extension installed"),this.setupBadge(),chrome.idle.setDetectionInterval(60)}),this.startSuspendDetection()}async checkCurrentTab(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e?.url&&this.checkWorkSite(e.url)}catch(e){console.error("Error checking current tab:",e)}}checkWorkSite(e){const t=this.data.workSites.some(t=>e.includes(t));console.log("Checking work site:",{url:e,isWorkSite:t,isWorking:this.data.isWorking,isUserActive:this.isUserActive,isSystemActive:this.isSystemActive,workSites:this.data.workSites}),t&&!this.data.isWorking&&this.isSystemActive?(console.log("Starting work - work site and system active"),this.startWork()):t&&this.isSystemActive||!this.data.isWorking||(console.log("Stopping work - conditions not met:",{isWorkSite:t,isSystemActive:this.isSystemActive}),this.stopWork())}pauseTracking(){this.data.isWorking&&(console.log("Pausing tracking due to inactivity/sleep"),this.stopWork())}startWork(){this.data.isWorking=!0,this.data.startTime=Date.now(),this.updateBadge("ON"),console.log("Started working")}stopWork(){if(this.data.isWorking){const e=Date.now()-this.data.startTime;this.data.currentWorkTime+=e,this.data.dailyWorkTime+=e,this.data.isWorking=!1,this.updateBadge("OFF"),this.saveData(),this.syncToFirebase(),console.log("Stopped working. Duration:",e)}}updateBadge(e){chrome.action.setBadgeText({text:e}),chrome.action.setBadgeBackgroundColor({color:"ON"===e?"#10b981":"#6b7280"})}setupBadge(){chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"#6b7280"})}startSuspendDetection(){this.activityCheckInterval=setInterval(()=>{const e=Date.now(),t=e-this.lastActivityTime;t>1e4&&(console.log("System suspend detected (time gap:",t,"ms)"),this.isSystemActive=!1,this.pauseTracking(),this.isSystemActive=!0,this.checkCurrentTab()),this.lastActivityTime=e},5e3)}startTracking(){setInterval(()=>{if(this.data.isWorking&&this.isSystemActive){const e=Date.now()-this.data.startTime;this.data.currentWorkTime+=e,this.data.dailyWorkTime+=e,this.data.startTime=Date.now(),this.saveData(),this.syncToFirebase()}else this.data.isWorking&&!this.isSystemActive&&this.pauseTracking()},5e3),setInterval(()=>{this.data.userId&&this.data.dailyWorkTime>0&&this.syncToFirebase()},3e4),chrome.idle.setDetectionInterval(60)}resetDailyIfNeeded(){const e=(new Date).toDateString();this.data.lastResetDate!==e&&(this.data.dailyWorkTime=0,this.data.lastResetDate=e,this.saveData(),this.syncToFirebase(),this.resetStreaksForInactiveUsers())}async resetStreaksForInactiveUsers(){try{const{DailyStatsService:e}=await Promise.all([a.e(977),a.e(424),a.e(515),a.e(368),a.e(83),a.e(96),a.e(76)]).then(a.bind(a,6164));await e.resetStreakForInactiveUsers(),console.log("Daily streak reset completed")}catch(e){console.error("Failed to reset streaks for inactive users:",e)}}async syncToFirebase(){if(this.data.userId)try{chrome.runtime.sendMessage({action:"syncDailyStats",userId:this.data.userId,dailyWorkTime:this.data.dailyWorkTime}).catch(()=>{console.log("Popup not open, skipping sync message")})}catch(e){console.error("Failed to sync to Firebase:",e)}}async handleMessage(e,t,s){try{switch(e.action){case"pageVisible":e.url&&this.checkWorkSite(e.url),s({success:!0});break;case"pageHidden":"navigation"!==e.reason&&"tab_switch"!==e.reason||this.pauseTracking(),s({success:!0});break;case"userActivity":this.isUserActive=!0,this.lastActivityTime=Date.now(),e.url&&this.checkWorkSite(e.url),s({success:!0});break;case"getWorkTime":s({workTime:this.data.currentWorkTime,dailyWorkTime:this.data.dailyWorkTime,isWorking:this.data.isWorking});break;case"getWorkSites":s({workSites:this.data.workSites});break;case"addWorkSite":e.site&&!this.data.workSites.includes(e.site)?(this.data.workSites.push(e.site),await this.saveData(),s({success:!0})):s({success:!1,error:"Site already exists or invalid"});break;case"removeWorkSite":this.data.workSites=this.data.workSites.filter(t=>t!==e.site),await this.saveData(),s({success:!0});break;case"getStatus":s({isWorking:this.data.isWorking,workSites:this.data.workSites,dailyWorkTime:this.data.dailyWorkTime});break;case"setUserId":this.data.userId=e.userId,await this.saveData(),s({success:!0});break;case"getUserId":s({userId:this.data.userId});break;case"syncToFirebase":this.syncToFirebase(),s({success:!0});break;default:s({error:"Unknown action"})}}catch(e){console.error("Error handling message:",e),s({error:"Internal error"})}}}})();